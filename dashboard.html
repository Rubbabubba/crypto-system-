<!doctype html>
<html lang="en">
<head>
  <!-- Crypto System Dashboard UI v1.2.0 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{SERVICE_NAME} — Dashboard</title>
  <style>
    :root{
      --bg:#0c0f14;
      --card-bg:#121720;
      --border:#223041;
      --text:#e8eef7;
      --muted:#9bb0c3;
      --pill-bg:rgba(255,255,255,0.04);
      --btn-bg:#111722;
      --accent:#4ea7ff;
      --ok:#2e7d32;
      --warn:#c62828;
      --warn-bg:#301a1a;
      --ok-bg:#15281a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap-page{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    header h1{font-size:20px;margin:0}
    header .meta{color:var(--muted);font-size:13px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .card{border:1px solid var(--border);border-radius:12px;background:var(--card-bg);padding:14px}
    .card-header{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:baseline;margin-bottom:8px}
    .card-header h2{font-size:16px;margin:0}
    .subtext{opacity:.85;color:var(--muted);font-size:13px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .dot::before{content:"•";opacity:.6}

    /* Layout: 3 cards on top row, console full-width below (desktop) */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns:1fr;
      grid-template-areas:
        "control"
        "prices"
        "pnl"
        "console";
    }
    @media(min-width:1000px){
      .grid{
        grid-template-columns:1fr 1fr 1fr;
        grid-template-areas:
          "control prices pnl"
          "console console console";
      }
    }
    #control-panel{grid-area:control}
    #live-prices{grid-area:prices}
    #pnl{grid-area:pnl}
    #console-card{grid-area:console}

    .row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);background:var(--btn-bg);color:var(--text);border-radius:8px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.success{border-color:var(--ok)}
    .btn.danger{border-color:var(--warn)}
    .btn.ghost{background:transparent}

    .grid2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:700px){.grid2{grid-template-columns:1fr 1fr}}

    .pill-list.wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;max-width:100%}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--pill-bg);font-size:13px;line-height:1.2;max-width:100%;word-break:break-word;overflow-wrap:anywhere}

    .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
    .kv dt{color:var(--muted)}
    .kv dd{margin:0}

    .price-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    @media(min-width:600px){ .price-grid{grid-template-columns:repeat(3,1fr);} }
    @media(min-width:1000px){ .price-grid{grid-template-columns:repeat(2,1fr);} } /* keep balanced in that column */
    .price-card{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      background:rgba(255,255,255,0.02);
      min-height:64px;
    }
    .price-card .sym{font-weight:600}
    .price-card .px{font-size:16px}
    .price-card .err{color:#ff8a80}

    .stat-tiles{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    @media(min-width:600px){ .stat-tiles{grid-template-columns:repeat(4,1fr);} }
    .tile{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      background:rgba(255,255,255,0.02);
    }
    .tile .label{color:var(--muted);font-size:12px}
    .tile .val{font-size:18px;font-weight:700;margin-top:4px}
    .pos{background:var(--ok-bg)}
    .neg{background:var(--warn-bg)}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      background:transparent;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    th, td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);background:rgba(255,255,255,0.03)}
    tbody tr:last-child td{border-bottom:none}

    pre.console{width:100%;min-height:260px;max-height:520px;overflow:auto;background:#0a0e16;border:1px solid var(--border);border-radius:10px;padding:12px;margin:0;white-space:pre-wrap}

    footer{margin-top:18px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap-page">
    <header>
      <h1>{SERVICE_NAME}</h1>
      <div class="meta">
        <span class="badge">App <strong>v{APP_VERSION}</strong></span>
        <span class="badge">Dashboard UI <strong>v1.2.0</strong></span>
        <span class="badge">Broker <strong id="badge_broker">{BROKER_BADGE}</strong></span>
      </div>
    </header>

    <div class="grid">
      <!-- ============ CONTROL PANEL ============ -->
      <section id="control-panel" class="card">
        <div class="card-header">
          <h2>Control Panel</h2>
          <div class="subtext">
            <span id="svc_name">{SERVICE_NAME}</span>
            <span class="dot"></span>
            <span id="svc_version">v{APP_VERSION}</span>
            <span class="dot"></span>
            <span id="svc_broker">{BROKER_TEXT}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Scheduler controls -->
          <div class="row">
            <button id="btn_sched_status" class="btn" onclick="schedulerStatus()">Scheduler Status</button>
          </div>
          <div class="row">
            <button id="btn_sched_start" class="btn success" onclick="schedulerStart()">Start Scheduler</button>
            <button id="btn_sched_stop" class="btn danger"  onclick="schedulerStop()">Stop Scheduler</button>
          </div>

          <!-- Symbols & Strategies -->
          <div class="grid2" style="margin-top:10px">
            <div>
              <h3 style="margin:0 0 6px">Symbols</h3>
              <div id="symbols_list" class="pill-list wrap"></div>
            </div>
            <div>
              <h3 style="margin:0 0 6px">Strategies</h3>
              <div id="strategies_list" class="pill-list wrap"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============ LIVE PRICES ============ -->
      <section id="live-prices" class="card">
        <div class="card-header">
          <h2>Live Prices</h2>
          <div class="subtext">Auto-refresh every 10s from /price endpoints</div>
        </div>
        <div id="prices_container" class="price-grid" aria-live="polite"></div>
        <div class="row">
          <button class="btn" onclick="refreshPrices()">Refresh Now</button>
        </div>
      </section>

      <!-- ============ P&L ============ -->
      <section id="pnl" class="card">
        <div class="card-header">
          <h2>P&amp;L</h2>
          <div class="subtext">Aggregated from /pnl/summary</div>
        </div>

        <!-- Totals -->
        <div class="stat-tiles" id="pnl_tiles">
          <div class="tile"><div class="label">Realized</div><div class="val" id="pnl_realized">—</div></div>
          <div class="tile"><div class="label">Unrealized</div><div class="val" id="pnl_unreal">—</div></div>
          <div class="tile"><div class="label">Fees</div><div class="val" id="pnl_fees">—</div></div>
          <div class="tile"><div class="label">Equity</div><div class="val" id="pnl_equity">—</div></div>
        </div>

        <!-- Tables -->
        <div class="grid2">
          <div>
            <h3 style="margin:6px 0">By Strategy (Top 5)</h3>
            <table id="tbl_strategy">
              <thead><tr><th>Strategy</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 style="margin:6px 0">By Symbol (Top 5)</h3>
            <table id="tbl_symbol">
              <thead><tr><th>Symbol</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="row">
          <button class="btn" onclick="refreshPnL()">Refresh P&amp;L</button>
        </div>
      </section>

      <!-- ============ CONSOLE (FULL WIDTH ROW 2) ============ -->
      <section id="console-card" class="card">
        <div class="card-header">
          <h2>Console</h2>
          <div class="subtext">Action logs (Scheduler, Prices, P&amp;L)</div>
        </div>
        <pre id="console_log" class="console" spellcheck="false"></pre>
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="clearConsole()">Clear</button>
          <button class="btn ghost" onclick="schedulerStatus()">Refresh Status</button>
          <button class="btn ghost" onclick="refreshPrices()">Refresh Prices</button>
          <button class="btn ghost" onclick="refreshPnL()">Refresh P&amp;L</button>
        </div>
      </section>
    </div>

    <footer>
      <div>© <span id="year"></span> {SERVICE_NAME}</div>
      <div>Broker: <strong>{BROKER_TEXT}</strong> · App v{APP_VERSION} · UI v1.2.0</div>
    </footer>
  </div>

  <script>
    /* ------------------------ Console helpers ------------------------ */
    function logToConsole(title, data) {
      try {
        const el = document.getElementById('console_log');
        if (!el) return;
        const time = new Date().toISOString();
        const payload = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
        el.textContent += `[${time}] ${title}:\n${payload}\n\n`;
        el.scrollTop = el.scrollHeight;
      } catch(e) { /* no-op */ }
    }
    function clearConsole() {
      const el = document.getElementById('console_log');
      if (el) el.textContent = '';
    }

    /* ------------------------ Control Panel ------------------------- */
    async function schedulerStatus() {
      try {
        const r = await fetch('/scheduler/status');
        const j = await r.json();
        logToConsole('scheduler/status', j);
        const running = !!j.running;
        document.getElementById('btn_sched_start')?.toggleAttribute('disabled', running);
        document.getElementById('btn_sched_stop')?.toggleAttribute('disabled', !running);
      } catch (e) {
        logToConsole('scheduler/status:error', String(e));
      }
    }
    async function schedulerStart() {
      try {
        const r = await fetch('/scheduler/start');
        const j = await r.json();
        logToConsole('scheduler/start', j);
        schedulerStatus();
      } catch (e) {
        logToConsole('scheduler/start:error', String(e));
      }
    }
    async function schedulerStop() {
      try {
        const r = await fetch('/scheduler/stop');
        const j = await r.json();
        logToConsole('scheduler/stop', j);
        schedulerStatus();
      } catch (e) {
        logToConsole('scheduler/stop:error', String(e));
      }
    }
    async function initConfig() {
      try {
        const r = await fetch('/config');
        const cfg = await r.json();
        const syms = (cfg.SYMBOLS || cfg.symbols || []);
        const strats = (cfg.STRATEGIES || cfg.strategies || []);
        const sl = document.getElementById('symbols_list');
        const tl = document.getElementById('strategies_list');
        if (sl) {
          sl.innerHTML = '';
          syms.forEach(s => {
            const d = document.createElement('div');
            d.className = 'pill';
            d.textContent = String(s);
            sl.appendChild(d);
          });
        }
        if (tl) {
          tl.innerHTML = '';
          strats.forEach(s => {
            const d = document.createElement('div');
            d.className = 'pill';
            d.textContent = String(s).toUpperCase();
            tl.appendChild(d);
          });
        }
        // cache for prices
        window.__SYMBOLS__ = syms;
      } catch (e) {
        logToConsole('config:error', String(e));
      }
    }

    /* -------------------------- Live Prices ------------------------- */
    function splitSymbol(sym) {
      const s = String(sym).toUpperCase().replace(/\s+/g,'');
      if (s.includes('/')) {
        const [base, quote] = s.split('/');
        return [base, quote];
      }
      // fallback: assume *USD if endswith USD
      if (s.endsWith('USD')) return [s.slice(0,-3), 'USD'];
      // default guess
      return [s, 'USD'];
    }
    async function fetchPriceSymbol(sym) {
      const [base, quote] = splitSymbol(sym);
      // Try /price/base/quote first; fallback to /price/{symbol}
      try {
        const r = await fetch(`/price/${encodeURIComponent(base)}/${encodeURIComponent(quote)}`);
        if (r.ok) return await r.json();
      } catch(_) {}
      try {
        const r2 = await fetch(`/price/${encodeURIComponent(sym)}`);
        if (r2.ok) return await r2.json();
      } catch(_) {}
      throw new Error('No price route matched for ' + sym);
    }
    function fmt(n){
      if (n === null || n === undefined || isNaN(n)) return '—';
      if (Math.abs(n) >= 1000) return Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
      if (Math.abs(n) >= 1) return Number(n).toLocaleString(undefined,{maximumFractionDigits:4});
      return Number(n).toLocaleString(undefined,{maximumFractionDigits:8});
    }
    async function refreshPrices() {
      const container = document.getElementById('prices_container');
      const syms = (window.__SYMBOLS__ || []).slice(0); // copy
      if (!container) return;
      if (!syms.length){ container.innerHTML = '<div class="subtext">No symbols configured.</div>'; return; }

      container.innerHTML = '';
      // Create cards first (stable order)
      const cards = {};
      syms.forEach(s => {
        const card = document.createElement('div');
        card.className = 'price-card';
        card.innerHTML = `<div class="sym">${s}</div><div class="px" id="px_${btoa(s)}">…</div>`;
        container.appendChild(card);
        cards[s] = card;
      });

      // Fetch in sequence (or parallel with Promise.all)
      await Promise.all(syms.map(async (s) => {
        try {
          const j = await fetchPriceSymbol(s);
          const px = j && j.price != null ? Number(j.price) : null;
          const el = document.getElementById('px_' + btoa(s));
          if (el) el.textContent = fmt(px);
          logToConsole('price', { symbol: s, price: px });
        } catch (e) {
          const el = document.getElementById('px_' + btoa(s));
          if (el) {
            el.textContent = 'error';
            el.classList.add('err');
          }
          logToConsole('price:error', { symbol: s, error: String(e) });
        }
      }));
    }
    let _priceTimer = null;
    function startPriceAutoRefresh() {
      stopPriceAutoRefresh();
      _priceTimer = setInterval(refreshPrices, 10000); // 10s
    }
    function stopPriceAutoRefresh() {
      if (_priceTimer) clearInterval(_priceTimer);
      _priceTimer = null;
    }

    /* ----------------------------- P&L ------------------------------- */
    function setTile(id,val,highlight=false){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = fmt(val);
      const parent = el.closest('.tile');
      if (parent) {
        parent.classList.remove('pos','neg');
        if (highlight){
          parent.classList.add(val >= 0 ? 'pos' : 'neg');
        }
      }
    }
    function fillTable(tbody, rows, key) {
      tbody.innerHTML = '';
      rows.slice(0,5).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${String(r[key])}</td>
          <td>${fmt(r.realized)}</td>
          <td>${fmt(r.unrealized)}</td>
          <td>${fmt(r.fees)}</td>
          <td>${fmt(r.equity)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    async function refreshPnL() {
      try {
        const r = await fetch('/pnl/summary');
        const j = await r.json();
        logToConsole('pnl/summary', j);
        if (!j || !j.ok) return;

        const t = j.total || { realized:0, unrealized:0, fees:0, equity:0 };
        setTile('pnl_realized', t.realized, true);
        setTile('pnl_unreal',  t.unrealized, true);
        setTile('pnl_fees',    t.fees);
        setTile('pnl_equity',  t.equity, true);

        const tbS = document.querySelector('#tbl_strategy tbody');
        const tbY = document.querySelector('#tbl_symbol tbody');
        fillTable(tbS, j.per_strategy || [], 'strategy');
        fillTable(tbY, j.per_symbol   || [], 'symbol');
      } catch (e) {
        logToConsole('pnl/summary:error', String(e));
      }
    }

    /* ---------------------------- Init ------------------------------- */
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('year').textContent = new Date().getFullYear().toString();
      await initConfig();
      await schedulerStatus();
      await refreshPrices();
      startPriceAutoRefresh();
      await refreshPnL();
    });
  </script>
</body>
</html>
