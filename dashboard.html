<!doctype html>
<html lang="en">
<head>
  <!-- Crypto System Dashboard UI v2.0.0 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto System — Dashboard</title>
  <style>
    :root {
      --bg: #050806;
      --bg-alt: #101712;
      --card-bg: #111a13;
      --border: #253427;
      --border-soft: #1a261b;
      --text: #f7fff8;
      --muted: #9bb39d;
      --accent: #33d17a;
      --accent-soft: rgba(51,209,122,0.18);
      --accent-strong: #1fa466;
      --bad: #e5534b;
      --bad-soft: rgba(229,83,75,0.18);
      --warn: #f6c453;
      --ok: #33d17a;
      --card-radius: 16px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.45);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Ubuntu, Cantarell, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top left, #19341f 0, #050806 55%);
      color: var(--text);
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    .wrap-page {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    header .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: radial-gradient(circle at top left, rgba(255,255,255,0.06), rgba(0,0,0,0.4));
      backdrop-filter: blur(18px);
    }

    .badge strong { font-weight: 600; color: #ffffff; }

    /* Cards & layout */
    .card {
      border-radius: var(--card-radius);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, rgba(94,137,104,0.07), var(--card-bg));
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 6px;
    }

    .card-header h2 {
      font-size: 15px;
      margin: 0;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e6f5e9;
    }

    .card-header .subtext {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }

    .pill.ok { border-color: rgba(116,229,172,0.6); color: #7cf0b5; }
    .pill.bad { border-color: rgba(247,130,117,0.7); color: #ffb4ac; }
    .pill.warn { border-color: rgba(246,196,83,0.6); color: #fce4a3; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    @media (min-width: 880px) {
      .kpi-grid {
        grid-template-columns: repeat(5, minmax(0,1fr));
      }
    }

    .kpi-card {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, rgba(16,24,19,0.96), rgba(12,18,14,0.96));
      padding: 9px 10px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 54px;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 17px;
      font-weight: 600;
      margin-top: 2px;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-good { color: var(--ok); }
    .kpi-bad { color: var(--bad); }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0,1.4fr);
      gap: 14px;
    }

    @media (min-width: 1024px) {
      .main-grid {
        grid-template-columns: minmax(0,1.5fr) minmax(0,1.2fr);
        grid-template-rows: auto auto auto;
        grid-template-areas:
          "perf risk"
          "calendar side"
          "ops ops";
      }
      #card-perf { grid-area: perf; }
      #card-risk { grid-area: risk; }
      #card-calendar { grid-area: calendar; }
      #side-column { grid-area: side; display: flex; flex-direction: column; gap: 14px; }
      #card-ops { grid-area: ops; }
    }

    @media (max-width: 1023.98px) {
      #side-column { display: flex; flex-direction: column; gap: 14px; }
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0;
    }

    .btn {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #101711;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover { filter: brightness(1.07); }
    .btn:disabled { opacity: 0.55; cursor: default; }

    .btn.primary {
      background: radial-gradient(circle at top left, var(--accent-strong), #0f341f);
      border-color: rgba(114,234,168,0.8);
    }

    .btn.danger {
      background: radial-gradient(circle at top left, #a62526, #451313);
      border-color: rgba(255,140,130,0.85);
    }

    .btn.small { padding: 4px 8px; font-size: 11px; }

    .link-open {
      font-size: 11px;
      color: var(--muted);
      text-decoration: underline;
      opacity: 0.9;
    }

    /* Performance card */
    .perf-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .perf-metrics div span.value {
      font-weight: 600;
      color: #ffffff;
      margin-left: 4px;
    }

    .perf-bars {
      margin-top: 6px;
      border-radius: 12px;
      background: #0c130e;
      padding: 8px 8px 4px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
    }

    .perf-bar-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }

    .perf-bar-label {
      width: 80px;
      color: var(--muted);
    }

    .perf-bar-track {
      flex: 1;
      border-radius: 999px;
      background: #070c08;
      overflow: hidden;
      height: 8px;
      position: relative;
    }

    .perf-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(83,220,140,0.95), rgba(37,134,80,0.95));
      width: 0%;
      transition: width 0.4s ease-out;
    }

    .perf-bar-fill.neg {
      background: linear-gradient(90deg, rgba(232,93,93,0.95), rgba(155,55,55,0.95));
    }

    .perf-bar-value {
      width: 80px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    /* Calendar */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .calendar-header strong {
      font-size: 14px;
      color: #ffffff;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      gap: 5px;
      margin-top: 8px;
      font-size: 11px;
    }

    .calendar-weekdays {
      display: contents;
    }

    .weekday {
      text-align: center;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-size: 10px;
      padding-bottom: 2px;
    }

    .day-cell {
      min-height: 54px;
      border-radius: 12px;
      padding: 4px 5px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid rgba(255,255,255,0.04);
      background: rgba(5,8,6,0.9);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .day-cell.empty {
      opacity: 0.25;
      cursor: default;
    }

    .day-cell .day-num {
      font-size: 11px;
      color: var(--muted);
    }

    .day-cell .pnl {
      font-size: 11px;
      font-variant-numeric: tabular-nums;
    }

    .day-cell.pos {
      border-color: rgba(88,215,143,0.7);
      background: radial-gradient(circle at top left, rgba(79,187,125,0.28), rgba(3,20,10,0.95));
    }

    .day-cell.neg {
      border-color: rgba(232,93,93,0.7);
      background: radial-gradient(circle at top left, rgba(232,93,93,0.28), rgba(29,10,10,0.95));
    }

    .day-cell.selected::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.7);
      pointer-events: none;
    }

    .calendar-summary {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Side column cards */
    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    .mini-table th,
    .mini-table td {
      padding: 4px 2px;
      text-align: left;
    }

    .mini-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .mini-table td {
      border-bottom: 1px solid rgba(255,255,255,0.03);
      font-variant-numeric: tabular-nums;
    }

    .mini-table tr:last-child td {
      border-bottom: none;
    }

    .pill-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
      margin: 2px;
      background: rgba(10,16,11,0.9);
    }

    .pill-chip .tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .list-compact {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .list-compact li + li {
      margin-top: 4px;
    }

    /* Ops + console */
    .ops-grid {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.4fr);
      gap: 12px;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .ops-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .ops-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    textarea.console {
      width: 100%;
      min-height: 130px;
      max-height: 220px;
      background: #050806;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 6px 8px;
      color: #d7f0dd;
      font-family: "JetBrains Mono", "SF Mono", Menlo, Consolas, monospace;
      font-size: 11px;
      resize: vertical;
      white-space: pre;
    }

    .muted {
      color: var(--muted);
      font-size: 11px;
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap-page">
    <header>
      <h1 id="hdr_service">Crypto System</h1>
      <div class="meta">
        <span class="badge">Broker: <strong>kraken</strong></span>
        <span class="badge">App <strong id="hdr_app_version">v?</strong></span>
        <span class="badge">UI <strong>v2.0.0</strong></span>
        <span class="badge"><span>Symbols:</span> <strong id="hdr_symbols">—</strong></span>
        <span class="badge"><span>Strategies:</span> <strong id="hdr_strats">—</strong></span>
      </div>
    </header>

    <!-- TOP KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card" id="kpi-equity">
        <div class="kpi-label">Account Equity</div>
        <div class="kpi-value" id="kpi_equity_value">$0.00</div>
        <div class="kpi-sub" id="kpi_equity_sub">Today snapshot</div>
      </div>
      <div class="kpi-card" id="kpi-today">
        <div class="kpi-label">Today P&amp;L</div>
        <div class="kpi-value" id="kpi_today_value">$0.00</div>
        <div class="kpi-sub" id="kpi_today_sub">Realized, today only</div>
      </div>
      <div class="kpi-card" id="kpi-mtd">
        <div class="kpi-label">Month to Date</div>
        <div class="kpi-value" id="kpi_mtd_value">$0.00</div>
        <div class="kpi-sub" id="kpi_mtd_sub">Realized P&amp;L this month</div>
      </div>
      <div class="kpi-card" id="kpi-risk">
        <div class="kpi-label">Open Exposure</div>
        <div class="kpi-value" id="kpi_exposure_value">$0.00</div>
        <div class="kpi-sub" id="kpi_exposure_sub">vs caps</div>
      </div>
      <div class="kpi-card" id="kpi-scheduler">
        <div class="kpi-label">Scheduler</div>
        <div class="kpi-value" id="kpi_sched_value">—</div>
        <div class="kpi-sub" id="kpi_sched_sub">status &amp; last run</div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="main-grid">
      <!-- Performance card -->
      <section class="card" id="card-perf">
        <div class="card-header">
          <h2>Performance</h2>
          <div class="subtext">
            <span>This month vs last month</span>
            <span id="perf_range_label" class="pill">MTD</span>
          </div>
        </div>
        <div class="perf-metrics">
          <div>
            This month:
            <span class="value" id="perf_this_month_value">$0.00</span>
          </div>
          <div>
            Last month:
            <span class="value" id="perf_last_month_value">$0.00</span>
          </div>
          <div>
            Change:
            <span class="value" id="perf_delta_value">$0.00</span>
          </div>
        </div>
        <div class="perf-bars">
          <div class="perf-bar-row">
            <div class="perf-bar-label">This month</div>
            <div class="perf-bar-track">
              <div class="perf-bar-fill" id="perf_bar_this"></div>
            </div>
            <div class="perf-bar-value" id="perf_bar_this_val">$0.00</div>
          </div>
          <div class="perf-bar-row">
            <div class="perf-bar-label">Last month</div>
            <div class="perf-bar-track">
              <div class="perf-bar-fill" id="perf_bar_last"></div>
            </div>
            <div class="perf-bar-value" id="perf_bar_last_val">$0.00</div>
          </div>
        </div>
        <div class="calendar-summary" id="perf_extra_summary">
          <!-- Filled by JS with e.g. best/worst day stats later if desired -->
        </div>
      </section>

      <!-- Risk & positions -->
      <section class="card" id="card-risk">
        <div class="card-header">
          <h2>Risk &amp; Positions</h2>
          <div class="subtext">
            <span class="pill" id="risk_pill">Loading…</span>
          </div>
        </div>
        <div class="row muted">
          <span>Open notional:</span>
          <span id="risk_open_notional">$0.00</span>
        </div>
        <div class="row muted">
          <span>Cap (sum of per-symbol caps):</span>
          <span id="risk_cap">$0.00</span>
        </div>
        <div class="row muted">
          <span>Usage:</span>
          <span id="risk_usage">0%</span>
        </div>
        <div class="row muted">
          <span>Positions:</span>
          <span id="risk_pos_count">0</span>
        </div>
        <table class="mini-table" id="risk_positions_table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Strat</th>
              <th>Qty</th>
              <th>Px</th>
              <th>U%</th>
            </tr>
          </thead>
          <tbody>
            <!-- filled by JS -->
          </tbody>
        </table>
      </section>

      <!-- Calendar -->
      <section class="card" id="card-calendar">
        <div class="card-header">
          <h2>Trading Calendar</h2>
          <div class="subtext">
            <span id="calendar_month_label">Month</span>
            <span class="pill" id="calendar_month_total">Total: $0.00</span>
          </div>
        </div>
        <div class="calendar-header">
          <div>
            <strong id="calendar_month_name">—</strong>
          </div>
          <div>
            <span id="calendar_win_loss">W: 0 · L: 0 · Flat: 0</span>
          </div>
        </div>
        <div class="calendar-grid" id="calendar_grid">
          <!-- weekdays + days injected via JS -->
        </div>
        <div class="calendar-summary">
          <span id="calendar_selected_summary">Select a day for details.</span>
        </div>
      </section>

      <!-- Right column (strategies, recent trades, advisor) -->
      <div id="side-column">
        <!-- Strategies & Symbols -->
        <section class="card" id="card-strats">
          <div class="card-header">
            <h2>Top Strategies &amp; Symbols (MTD)</h2>
            <div class="subtext">
              <span class="pill" id="strat_range_label">This month</span>
            </div>
          </div>
          <div class="row">
            <div style="flex:1;">
              <div class="ops-section-title">By Strategy</div>
              <table class="mini-table" id="table_by_strategy">
                <thead>
                  <tr>
                    <th>Strat</th><th>P&amp;L</th><th>Fees</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div style="flex:1;">
              <div class="ops-section-title">By Symbol</div>
              <table class="mini-table" id="table_by_symbol">
                <thead>
                  <tr>
                    <th>Symbol</th><th>P&amp;L</th><th>Fees</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Recent trades -->
        <section class="card" id="card-trades">
          <div class="card-header">
            <h2>Recent Trades</h2>
            <div class="subtext">
              <span class="pill" id="trades_count_pill">Last 10 fills</span>
			  <a class="link-open" href="/fills" target="_blank">view more</a>
            </div>
          </div>
          <table class="mini-table" id="table_trades">
            <thead>
              <tr>
                <th>Time</th><th>Sym</th><th>Side</th><th>Qty</th><th>Px</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Advisor -->
        <section class="card" id="card-advisor">
          <div class="card-header">
            <h2>Advisor</h2>
            <div class="subtext">
              <span id="advisor_date">—</span>
            </div>
          </div>
          <div class="muted" id="advisor_notes">No advisor data loaded.</div>
          <ul class="list-compact" id="advisor_recs"></ul>
          <div class="row" style="margin-top:8px;">
            <button class="btn small" onclick="runAdvisor()">Refresh</button>
            <button class="btn small" onclick="applyAdvisor(true)">Apply (dry)</button>
            <button class="btn small danger" onclick="applyAdvisor(false)">Apply (live)</button>
            <a class="link-open" href="/advisor/daily" target="_blank">open</a>
          </div>
        </section>
      </div>

      <!-- Ops & logs -->
      <section class="card" id="card-ops">
        <div class="card-header">
          <h2>Operations &amp; Logs</h2>
          <div class="subtext">
            <span class="pill">Scheduler &amp; journal controls</span>
          </div>
        </div>
        <div class="ops-grid">
          <div>
            <div class="ops-section-title">Controls</div>
            <div class="row">
              <button class="btn small" onclick="schedulerStatus()">Status</button>
              <button class="btn small primary" onclick="schedulerStart()">Start</button>
              <button class="btn small danger" onclick="schedulerStop()">Stop</button>
              <button class="btn small" onclick="schedulerRunOnce()">Run once</button>
            </div>
            <div class="row">
              <button class="btn small" onclick="journalBackfill()">Journal backfill</button>
              <button class="btn small" onclick="journalSync()">Journal sync</button>
            </div>
            <div class="row">
              <a class="link-open" href="/health" target="_blank">/health</a>
              <a class="link-open" href="/config" target="_blank">/config</a>
              <a class="link-open" href="/fills" target="_blank">/fills</a>
              <a class="link-open" href="/routes" target="_blank">/routes</a>
            </div>
            <div class="row">
              <span class="muted">Any responses/errors will appear in the log.</span>
            </div>
          </div>
          <div>
            <div class="ops-section-title">Log</div>
            <textarea id="console_log" class="console" readonly></textarea>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const $id = id => document.getElementById(id);

    const logEl = () => $id("console_log");

    function log(msg, detail) {
      const el = logEl();
      if (!el) return;
      const ts = new Date().toISOString().replace("T"," ").replace(/\..+/, "");
      let line = "[" + ts + "] " + msg;
      if (detail !== undefined) {
        try {
          if (typeof detail === "string") {
            line += " :: " + detail;
          } else {
            line += " :: " + JSON.stringify(detail);
          }
        } catch (e) {
          line += " :: " + String(detail);
        }
      }
      el.value += line + "\\n";
      el.scrollTop = el.scrollHeight;
    }

    function money(v) {
      const n = Number(v || 0);
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(n);
      return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }

    function pct(v) {
      if (v === null || v === undefined || !isFinite(v)) return "—";
      return (v >= 0 ? "+" : "") + v.toFixed(2) + "%";
    }

    async function fetchJSON(path) {
      try {
        const r = await fetch(path, { cache: "no-store" });
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!r.ok) {
          log("HTTP " + r.status + " " + path, data);
          throw new Error("HTTP " + r.status);
        }
        return data;
      } catch (e) {
        log("FETCH FAIL " + path, String(e));
        throw e;
      }
    }

    async function postJSON(path, payload) {
      try {
        const r = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload ? JSON.stringify(payload) : "{}",
        });
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (!r.ok) {
          log("HTTP " + r.status + " " + path, data);
          throw new Error("HTTP " + r.status);
        }
        log("POST " + path + " ok", data);
        return data;
      } catch (e) {
        log("POST FAIL " + path, String(e));
        throw e;
      }
    }

    window.onerror = (msg, src, line, col, err) => {
      log("window.onerror", { msg, src, line, col, err: String(err) });
    };
    window.onunhandledrejection = ev => {
      log("unhandledrejection", String(ev && ev.reason || ev));
    };

    // ===== Date helpers =====
    function pad2(n) { return String(n).padStart(2,"0"); }

    function toIsoNoMs(d) {
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate())
           + "T" + pad2(d.getHours()) + ":" + pad2(d.getMinutes()) + ":" + pad2(d.getSeconds());
    }

    function startOfDay(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0);
    }

    function endOfDay(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59);
    }

    function firstOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0);
    }

    function lastOfPreviousMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 0, 23,59,59); // day 0 = last day of previous month
    }

    function firstOfPreviousMonth(d) {
      const prev = new Date(d.getFullYear(), d.getMonth()-1, 1, 0,0,0);
      return prev;
    }

    function daysInMonth(year, monthIndex) {
      return new Date(year, monthIndex+1, 0).getDate();
    }

    // ===== Global state for calendar/perf =====
    const DailyCache = {
      // keys: "YYYY-MM" -> [{day, realized}]
    };

	// ===== Daily P&L helper using /pnl2/daily =====
	async function getDailyForMonth(year, monthIndex) {
	  // monthIndex is 0-based (0 = Jan)
	  const key = year + "-" + pad2(monthIndex + 1);
	  if (DailyCache[key]) return DailyCache[key];

	  const month = monthIndex + 1; // API is 1-based (1 = Jan)

	  try {
		const res = await fetchJSON(`/pnl2/daily?year=${year}&month=${month}`);
		const rows = (res && (res.rows || res.daily)) || [];

		const normalized = rows
		  .map(r => ({
			day: Number(r.day),
			realized: Number(r.realized || 0),
		  }))
		  .filter(r => !Number.isNaN(r.day))
		  .sort((a, b) => a.day - b.day);

		DailyCache[key] = normalized;
		return normalized;
	  } catch (e) {
		log("getDailyForMonth failed, falling back to zeros", String(e));
		const days = daysInMonth(year, monthIndex);
		const out = [];
		for (let day = 1; day <= days; day++) {
		  out.push({ day, realized: 0 });
		}
		DailyCache[key] = out;
		return out;
	  }
	}

    // ===== Top bar: config & KPIs =====
    async function initConfig() {
      try {
        const cfg = await fetchJSON("/config");
        $id("hdr_service").textContent = cfg.service || "Crypto System";
        $id("hdr_app_version").textContent = "v" + (cfg.version || "?");
        $id("hdr_symbols").textContent = (cfg.symbols || []).join(", ") || "—";
        $id("hdr_strats").textContent = (cfg.strategies || []).join(", ") || "—";
      } catch (e) {
        log("initConfig failed", String(e));
      }
    }

    async function updateTopKpis() {
      try {
        const now = new Date();

        // Today summary
        const todayRes = await fetchJSON(
          "/pnl2/summary?start=" + encodeURIComponent(toIsoNoMs(startOfDay(now))) +
          "&end=" + encodeURIComponent(toIsoNoMs(endOfDay(now)))
        );

        const todayTotal = todayRes.total || {};
        const todayRealized = todayTotal.realized || 0;
        const todayEquity = todayTotal.equity || 0;

        $id("kpi_today_value").textContent = money(todayRealized);
        $id("kpi_today_value").classList.remove("kpi-good","kpi-bad");
        if (todayRealized > 0) $id("kpi_today_value").classList.add("kpi-good");
        if (todayRealized < 0) $id("kpi_today_value").classList.add("kpi-bad");
        $id("kpi_today_sub").textContent = "Realized today";

        // MTD (use /pnl2/daily so it matches performance/calendar exactly)
		const mtdStart = firstOfMonth(now);
		const mtdEnd = endOfDay(now);

		// equity snapshot still from /pnl2/summary
		const mtdRes = await fetchJSON(
		  "/pnl2/summary?start=" + encodeURIComponent(toIsoNoMs(mtdStart)) +
		  "&end=" + encodeURIComponent(toIsoNoMs(mtdEnd))
		);
		const mtdTotal = mtdRes.total || {};
		const equitySnap = mtdTotal.equity || 0;

		// realized MTD from daily
		const dailyThisMonth = await getDailyForMonth(now.getFullYear(), now.getMonth());
		const mtdRealized = dailyThisMonth.reduce((acc, d) => acc + (d.realized || 0), 0);

		$id("kpi_mtd_value").textContent = money(mtdRealized);
		$id("kpi_mtd_value").classList.remove("kpi-good","kpi-bad");
		if (mtdRealized > 0) $id("kpi_mtd_value").classList.add("kpi-good");
		if (mtdRealized < 0) $id("kpi_mtd_value").classList.add("kpi-bad");
		$id("kpi_mtd_sub").textContent = "Realized P&L since " + mtdStart.toISOString().slice(0,10);

		// Equity from snapshot
		$id("kpi_equity_value").textContent = money(equitySnap);
		$id("kpi_equity_sub").textContent = "Equity from pnl2 snapshot";


      } catch (e) {
        log("updateTopKpis failed", String(e));
      }

      // Scheduler + risk handled in their own functions
      await updateSchedulerKpi();
      await updateRiskCard();
    }

    async function updateSchedulerKpi() {
      try {
        const status = await fetchJSON("/scheduler/status");
        const last = await fetchJSON("/scheduler/last").catch(() => null);
        const running = !!status.enabled;
        const label = running ? "RUNNING" : "STOPPED";
        $id("kpi_sched_value").textContent = label;
        $id("kpi_sched_value").classList.remove("kpi-good","kpi-bad");
        $id("kpi_sched_value").classList.add(running ? "kpi-good" : "kpi-bad");
        let sub = "enabled=" + String(status.enabled) + ", ticks=" + String(status.ticks || status.tick || 0);
        if (last && last.last_ts) {
          sub += " • last " + String(last.last_ts);
        }
        $id("kpi_sched_sub").textContent = sub;
      } catch (e) {
        log("updateSchedulerKpi failed", String(e));
      }
    }

    // ===== Risk & positions card =====
    async function updateRiskCard() {
      try {
        const res = await fetchJSON("/debug/positions");
        const rows = (res && res.positions) || [];
        const tbody = $id("risk_positions_table").querySelector("tbody");
        tbody.innerHTML = "";

        let openNotional = 0;
        let capTotal = 0;
        rows.forEach(row => {
          const px = Number(row.last_price || 0);
          const qty = Number(row.qty || 0);
          const notional = Math.abs(px * qty);
          openNotional += notional;
          const cap = Number(row.max_notional_cap || 0);
          capTotal += cap > 0 ? cap : 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.symbol || ""}</td>
            <td>${row.strategy || ""}</td>
            <td>${qty.toFixed(4)}</td>
            <td>${px.toFixed(4)}</td>
            <td>${row.unrealized_pct == null ? "—" : pct(row.unrealized_pct)}</td>
          `;
          tbody.appendChild(tr);
        });

        const usage = capTotal > 0 ? (openNotional / capTotal) * 100 : 0;
        $id("risk_open_notional").textContent = money(openNotional);
        $id("risk_cap").textContent = capTotal ? money(capTotal) : "—";
        $id("risk_usage").textContent = capTotal ? usage.toFixed(1) + "%" : "—";
        $id("risk_pos_count").textContent = rows.length;

        const pill = $id("risk_pill");
        pill.classList.remove("ok","bad","warn");
        let label = "No positions";
        if (rows.length > 0) {
          if (usage < 40) {
            pill.classList.add("ok");
            label = "Comfortable (" + usage.toFixed(0) + "% used)";
          } else if (usage < 80) {
            pill.classList.add("warn");
            label = "Elevated (" + usage.toFixed(0) + "% used)";
          } else {
            pill.classList.add("bad");
            label = "High (" + usage.toFixed(0) + "% used)";
          }
        }
        pill.textContent = label;

        // Also pipe aggregate usage into KPI exposure
        $id("kpi_exposure_value").textContent = money(openNotional);
        $id("kpi_exposure_sub").textContent = capTotal ? usage.toFixed(1) + "% of caps" : "No caps configured";

      } catch (e) {
        log("updateRiskCard failed", String(e));
      }
    }

    // ===== Performance card (this month vs last month) =====
	async function updatePerformanceCard() {
	  const now = new Date();
	  const thisYear = now.getFullYear();
	  const thisMonthIdx = now.getMonth();

	  const prevFirst = firstOfPreviousMonth(now);
	  const prevYear = prevFirst.getFullYear();
	  const prevMonthIdx = prevFirst.getMonth();

	  // Load both months in parallel
	  const [thisMonthData, lastMonthData] = await Promise.all([
		getDailyForMonth(thisYear, thisMonthIdx),
		getDailyForMonth(prevYear, prevMonthIdx),
	  ]);

	  const sum = arr => arr.reduce((acc, d) => acc + (d.realized || 0), 0);

	  const thisSum = sum(thisMonthData);
	  const lastSum = sum(lastMonthData);
	  const delta = thisSum - lastSum;

	  $id("perf_this_month_value").textContent = money(thisSum);
	  $id("perf_last_month_value").textContent = money(lastSum);
	  $id("perf_delta_value").textContent = money(delta);
	  $id("perf_range_label").textContent = "MTD vs last month";

	  const maxAbs = Math.max(Math.abs(thisSum), Math.abs(lastSum), 1);
	  const thisPct = Math.abs(thisSum) / maxAbs * 100;
	  const lastPct = Math.abs(lastSum) / maxAbs * 100;

	  const barThis = $id("perf_bar_this");
	  const barLast = $id("perf_bar_last");
	  barThis.style.width = thisPct.toFixed(1) + "%";
	  barLast.style.width = lastPct.toFixed(1) + "%";
	  barThis.classList.toggle("neg", thisSum < 0);
	  barLast.classList.toggle("neg", lastSum < 0);
	  $id("perf_bar_this_val").textContent = money(thisSum);
	  $id("perf_bar_last_val").textContent = money(lastSum);

	  // Simple summary line
	  const totalDays = thisMonthData.length;
	  const greenDays = thisMonthData.filter(d => d.realized > 0).length;
	  const redDays = thisMonthData.filter(d => d.realized < 0).length;
	  const flatDays = totalDays - greenDays - redDays;

	  $id("perf_extra_summary").textContent =
		`This month: ${greenDays} green · ${redDays} red · ${flatDays} flat days.`;
	}


    // ===== Calendar card =====
    let CalendarState = {
      year: null,
      monthIdx: null,
      selectedDay: null,
      daily: [],
    };

    function renderCalendar() {
      const { year, monthIdx, daily, selectedDay } = CalendarState;
      if (year == null || monthIdx == null) return;

      const monthNames = ["January","February","March","April","May","June",
                          "July","August","September","October","November","December"];
      $id("calendar_month_name").textContent = monthNames[monthIdx] + " " + year;

      const daysCount = daily.length;
      const total = daily.reduce((acc,d)=>acc + (d.realized || 0), 0);
      $id("calendar_month_total").textContent = "Total: " + money(total);

      let wins = 0, losses = 0, flats = 0;
      daily.forEach(d=>{
        if (d.realized > 0) wins++;
        else if (d.realized < 0) losses++;
        else flats++;
      });
      $id("calendar_win_loss").textContent = "W: " + wins + " · L: " + losses + " · Flat: " + flats;

      const container = $id("calendar_grid");
      container.innerHTML = "";

      const weekdaysRow = document.createElement("div");
      weekdaysRow.className = "calendar-weekdays";
      const short = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      for (let i=0;i<7;i++) {
        const w = document.createElement("div");
        w.className = "weekday";
        w.textContent = short[i];
        weekdaysRow.appendChild(w);
      }
      container.appendChild(weekdaysRow);

      const firstDayIdx = new Date(year, monthIdx, 1).getDay(); // 0=Sun
      for (let i=0; i<firstDayIdx; i++) {
        const cell = document.createElement("div");
        cell.className = "day-cell empty";
        container.appendChild(cell);
      }

      daily.forEach(d => {
        const cell = document.createElement("div");
        cell.className = "day-cell";
        if (d.realized > 0) cell.classList.add("pos");
        else if (d.realized < 0) cell.classList.add("neg");
        if (selectedDay === d.day) cell.classList.add("selected");

        const num = document.createElement("div");
        num.className = "day-num";
        num.textContent = d.day;
        const pnlEl = document.createElement("div");
        pnlEl.className = "pnl";
        pnlEl.textContent = d.realized === 0 ? "$0.00" : (d.realized > 0 ? "+" : "") + money(d.realized).replace("-", "");

        cell.appendChild(num);
        cell.appendChild(pnlEl);

        cell.addEventListener("click", () => {
          CalendarState.selectedDay = d.day;
          updateCalendarSelectedSummary();
          renderCalendar();
        });

        container.appendChild(cell);
      });

      updateCalendarSelectedSummary();
    }

    async function initCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const monthIdx = now.getMonth();
      const daily = await getDailyForMonth(year, monthIdx);
      CalendarState = { year, monthIdx, daily, selectedDay: null };
      renderCalendar();
    }

    function updateCalendarSelectedSummary() {
      const { year, monthIdx, daily, selectedDay } = CalendarState;
      const labelEl = $id("calendar_selected_summary");
      if (!selectedDay) {
        labelEl.textContent = "Select a day for details.";
        return;
      }
      const d = daily.find(x => x.day === selectedDay);
      if (!d) {
        labelEl.textContent = "Select a day for details.";
        return;
      }
      const dateStr = year + "-" + pad2(monthIdx+1) + "-" + pad2(selectedDay);
      labelEl.textContent = " " + dateStr + ": " + money(d.realized) + " realized (PnL2 summary).";
    }

    // ===== Strategies & symbols (MTD) =====
    async function updateStratSymbolTables() {
      try {
        const now = new Date();
        const start = firstOfMonth(now);
        const end = endOfDay(now);
        const qs = "?start=" + encodeURIComponent(toIsoNoMs(start)) +
                   "&end=" + encodeURIComponent(toIsoNoMs(end));

        const byStrat = await fetchJSON("/pnl2/by_strategy" + qs);
        const bySym = await fetchJSON("/pnl2/by_symbol" + qs);

        const stratRows = (byStrat && byStrat.rows) || [];
        const symRows = (bySym && bySym.rows) || [];

        stratRows.sort((a,b)=>(b.realized||0)-(a.realized||0));
        symRows.sort((a,b)=>(b.realized||0)-(a.realized||0));

        const tbodyS = $id("table_by_strategy").querySelector("tbody");
        const tbodySym = $id("table_by_symbol").querySelector("tbody");
        tbodyS.innerHTML = "";
        tbodySym.innerHTML = "";

        stratRows.slice(0,6).forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.strategy}</td>
            <td>${money(r.realized || 0)}</td>
            <td>${money(r.fees || 0)}</td>
          `;
          tbodyS.appendChild(tr);
        });

        symRows.slice(0,6).forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.symbol}</td>
            <td>${money(r.realized || 0)}</td>
            <td>${money(r.fees || 0)}</td>
          `;
          tbodySym.appendChild(tr);
        });

        $id("strat_range_label").textContent = "This month";

      } catch (e) {
        log("updateStratSymbolTables failed", String(e));
      }
    }

    // ===== Recent trades =====
    async function updateRecentTrades() {
      try {
        const res = await fetchJSON("/fills?limit=10&offset=0");
        const rows = (res && res.rows) || [];
        const tbody = $id("table_trades").querySelector("tbody");
        tbody.innerHTML = "";

        rows.forEach(r => {
          const d = new Date((r.ts || 0) * 1000);
          const timeStr = isNaN(d.getTime())
            ? "—"
            : pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " +
              pad2(d.getHours()) + ":" + pad2(d.getMinutes());
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${timeStr}</td>
            <td>${r.symbol || ""}</td>
            <td>${(r.side || "").toUpperCase()}</td>
            <td>${Number(r.volume || 0).toFixed(4)}</td>
            <td>${Number(r.price || 0).toFixed(4)}</td>
          `;
          tbody.appendChild(tr);
        });

        $id("trades_count_pill").textContent = "Last " + rows.length + " fills";

      } catch (e) {
        log("updateRecentTrades failed", String(e));
      }
    }

    // ===== Advisor =====
    async function runAdvisor() {
      try {
        const data = await fetchJSON("/advisor/daily");
        $id("advisor_date").textContent = data.date || "—";
        $id("advisor_notes").textContent = data.notes || "No notes.";
        const ul = $id("advisor_recs");
        ul.innerHTML = "";
        const recs = data.recommendations || [];
        if (!recs.length) {
          const li = document.createElement("li");
          li.textContent = "No recommendations.";
          ul.appendChild(li);
        } else {
          recs.forEach(r => {
            const li = document.createElement("li");
            li.textContent = String(r.desc || r.text || JSON.stringify(r));
            ul.appendChild(li);
          });
        }
        log("Advisor loaded", { count: (data.recommendations || []).length });
      } catch (e) {
        log("runAdvisor failed", String(e));
      }
    }

    async function applyAdvisor(dryRun) {
      try {
        const payload = {
          date: new Date().toISOString().slice(0,10),
          notes: "Applied via dashboard (" + (dryRun ? "dry" : "live") + ")",
          recommendations: [], // server will reuse existing recs from daily.json
        };
        payload.dry_run = !!dryRun;
        await postJSON("/advisor/apply", payload);
      } catch (e) {
        log("applyAdvisor failed", String(e));
      }
    }

    // ===== Ops: scheduler & journal =====
    async function schedulerStatus() {
      await fetchJSON("/scheduler/status");
    }
    async function schedulerStart() {
      await postJSON("/scheduler/start");
      await updateSchedulerKpi();
    }
    async function schedulerStop() {
      await postJSON("/scheduler/stop");
      await updateSchedulerKpi();
    }
    async function schedulerRunOnce() {
      await postJSON("/scheduler/run");
      await updateSchedulerKpi();
    }
    async function journalBackfill() {
      await postJSON("/journal/backfill", {});
    }
    async function journalSync() {
      await postJSON("/journal/sync", {});
    }

    // ===== Init =====
    async function initDashboard() {
      log("Dashboard init starting");
      await initConfig();
      await updateTopKpis();
      await updatePerformanceCard();
      await initCalendar();
      await updateStratSymbolTables();
      await updateRecentTrades();
      await runAdvisor();
      log("Dashboard init complete");

      // Periodic refresh (lightweight subset)
      setInterval(() => {
        updateTopKpis();
        updateRecentTrades();
        updateStratSymbolTables();
      }, 60_000);
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>
