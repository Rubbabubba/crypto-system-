<!doctype html>
<html lang="en">
<head>
  <!-- Crypto System Dashboard UI v1.4.1 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{SERVICE_NAME} — Dashboard</title>
  <style>
    :root{
      --bg:#0c0f14;--card-bg:#121720;--border:#223041;--text:#e8eef7;--muted:#9bb0c3;
      --btn-bg:#111722;--accent:#4ea7ff;--ok:#2e7d32;--warn:#c62828;
      --good:#174a2a;--bad:#4a1f21;--mid:#1b2634;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}

    .wrap-page{width:100%;padding:16px 18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    header h1{font-size:20px;margin:0}
    header .meta{color:var(--muted);font-size:13px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);
      padding:4px 8px;border-radius:999px}
    .card{border:1px solid var(--border);border-radius:12px;background:var(--card-bg);padding:14px}
    .card-header{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:baseline;margin-bottom:8px}
    .subtext{opacity:.85;color:var(--muted);font-size:13px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .dot::before{content:"•";opacity:.6}

    .grid{display:grid;gap:16px;
      grid-template-areas:"control" "prices" "pnl" "calendar" "console";}
    @media(min-width:900px){
      .grid{grid-template-columns:1fr 1fr 1fr;
        grid-template-areas:"control prices pnl" "calendar calendar calendar" "console console console";}
    }
    #control-panel{grid-area:control}
    #live-prices{grid-area:prices}
    #pnl{grid-area:pnl}
    #calendar-pnl{grid-area:calendar}
    #console-card{grid-area:console}

    .row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);background:var(--btn-bg);
      color:var(--text);border-radius:8px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.success{border-color:var(--ok)}.btn.danger{border-color:var(--warn)}
    .link-open{font-size:12px;color:var(--muted);margin-left:6px}

    .mini-meta{margin-top:10px;padding:8px;border:1px dashed var(--border);
      border-radius:8px;color:var(--muted);font-size:12px}
    .mini-meta code{white-space:pre-wrap;word-break:break-word}

    table{width:100%;border-collapse:collapse;font-size:13px;background:transparent;
      border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);background:rgba(255,255,255,0.03)}
    tbody tr:last-child td{border-bottom:none}

    .stat-tiles{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    @media(min-width:600px){.stat-tiles{grid-template-columns:repeat(4,1fr)}}
    .tile{border:1px solid var(--border);border-radius:10px;padding:10px;background:rgba(255,255,255,0.02)}
    .tile .label{color:var(--muted);font-size:12px}.tile .val{font-size:18px;font-weight:700;margin-top:4px}
    .pos{background:#16291b}.neg{background:#2a1618}

    /* Calendar */
    .cal-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
    .nav-btn{background:none;border:none;color:var(--text);font-size:18px;cursor:pointer}
    .cal-title{font-weight:700}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-dow{color:var(--muted);font-size:12px;text-align:center}
    .cal-cell{border:1px solid var(--border);border-radius:12px;min-height:110px;padding:8px;
      display:flex;flex-direction:column;gap:6px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background .15s}
    .cal-cell:hover{filter:brightness(1.2)}
    .cal-cell.muted{opacity:.4;pointer-events:none}
    .cal-date{font-size:12px;color:var(--muted)}
    .cal-pnl{font-weight:700}
    .cal-metric{font-size:12px;color:var(--muted)}
    .cal-detail{margin-top:12px;border-top:1px solid var(--border);padding-top:10px;font-size:13px}
    .cal-detail table{font-size:12px}
    .swatch{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
    pre.console{width:100%;min-height:260px;max-height:520px;overflow:auto;background:#0a0e16;
      border:1px solid var(--border);border-radius:10px;padding:12px;margin:0;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap-page">
    <header>
      <h1>{SERVICE_NAME}</h1>
      <div class="meta">
        <span class="badge">App <strong>v{APP_VERSION}</strong></span>
        <span class="badge">Dashboard UI <strong>v1.4.1</strong></span>
        <span class="badge">Broker <strong id="badge_broker">{BROKER_BADGE}</strong></span>
      </div>
    </header>

    <div class="grid">
      <!-- ============ CONTROL PANEL (Service restored + Start/Stop) ============ -->
      <section id="control-panel" class="card">
        <div class="card-header">
          <h2>Control Panel</h2>
          <div class="subtext">
            <span>Crypto System</span>
            <span class="dot"></span>
            <span>v{APP_VERSION}</span>
            <span class="dot"></span>
            <span>{BROKER_TEXT}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Old Service buttons -->
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/health')">GET /health</button>
            <a class="link-open" href="/health" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/diag/broker')">GET /diag/broker</button>
            <a class="link-open" href="/diag/broker" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/version')">GET /version</button>
            <a class="link-open" href="/version" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/config')">GET /config</button>
            <a class="link-open" href="/config" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/fills')">GET /fills</button>
            <a class="link-open" href="/fills" target="_blank" rel="noopener">open</a>
          </div>

          <!-- Scheduler controls under Status -->
          <div class="row" style="margin-top:6px">
            <button id="btn_sched_status" class="btn" onclick="schedulerStatus()">GET /scheduler/status</button>
            <a class="link-open" href="/scheduler/status" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button id="btn_sched_start" class="btn success" onclick="schedulerStart()">/scheduler/start</button>
            <button id="btn_sched_stop"  class="btn danger"  onclick="schedulerStop()">/scheduler/stop</button>
          </div>

          <!-- Symbols / Strategies (wrap inside) -->
          <div class="mini-meta" id="mini_meta">
            <div><strong>Symbols:</strong> <code id="meta_symbols">—</code></div>
            <div><strong>Strategies:</strong> <code id="meta_strategies">—</code></div>
          </div>
        </div>
      </section>

      <!-- ============ LIVE PRICES (original table layout) ============ -->
      <section id="live-prices" class="card">
        <div class="card-header">
          <h2>Live Prices</h2>
          <div class="subtext">From /price/* — <span id="prices_hint">30s auto-refresh</span></div>
        </div>

        <table>
          <thead>
            <tr>
              <th class="col-symbol">Symbol</th>
              <th class="col-price">Price</th>
              <th class="col-spark">Spark</th>
              <th class="col-updated">Updated</th>
            </tr>
          </thead>
          <tbody id="prices_tbody"></tbody>
        </table>

        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="refreshPrices()">Refresh now</button>
        </div>
      </section>

      <!-- ============ P&L ============ -->
      <section id="pnl" class="card">
        <div class="card-header">
          <h2>P&amp;L</h2>
          <div class="subtext">Aggregated from /pnl/summary</div>
        </div>

        <div class="stat-tiles" id="pnl_tiles">
          <div class="tile"><div class="label">Realized</div><div class="val" id="pnl_realized">—</div></div>
          <div class="tile"><div class="label">Unrealized</div><div class="val" id="pnl_unreal">—</div></div>
          <div class="tile"><div class="label">Fees</div><div class="val" id="pnl_fees">—</div></div>
          <div class="tile"><div class="label">Equity</div><div class="val" id="pnl_equity">—</div></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <h3 style="margin:6px 0">By Strategy (Top 5)</h3>
            <table id="tbl_strategy">
              <thead><tr><th>Strategy</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 style="margin:6px 0">By Symbol (Top 5)</h3>
            <table id="tbl_symbol">
              <thead><tr><th>Symbol</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="refreshPnL()">Refresh P&amp;L</button>
        </div>
      </section>

      <!-- ============ CALENDAR P&L ============ -->
      <section id="calendar-pnl" class="card">
        <div class="card-header">
          <h2>Calendar P&amp;L</h2>
          <div class="subtext">Client-side FIFO realized attribution from /fills</div>
        </div>
        <div class="cal-head">
          <button class="nav-btn" id="prev_month">&#9664;</button>
          <div class="cal-title" id="cal_title">—</div>
          <button class="nav-btn" id="next_month">&#9654;</button>
        </div>
        <div class="cal-grid" id="cal_grid"></div>
        <div class="cal-detail" id="cal_detail"></div>
      </section>

      <!-- CONSOLE -->
      <section id="console-card" class="card">
        <div class="card-header"><h2>Console</h2></div>
        <pre id="console_log" class="console"></pre>
      </section>
    </div>

    <footer><div>© <span id="year"></span> {SERVICE_NAME}</div>
      <div>Broker: <strong>{BROKER_TEXT}</strong> · App v{APP_VERSION} · UI v1.4.1</div></footer>
  </div>

  <script>
    const log= (t,d)=>{const el=document.getElementById('console_log');if(!el)return;const ts=new Date().toISOString();el.textContent+=`[${ts}] ${t}:\n${JSON.stringify(d,null,2)}\n\n`;el.scrollTop=el.scrollHeight;}
    async function fetchJSON(p){try{const r=await fetch(p);return await r.json();}catch(e){log(p, String(e));return []}}

    /* --- Calendar Data --- */
    function parseFill(r){const s=(r.side||r.type||'').toLowerCase(),sym=(r.symbol||r.pair||'').toUpperCase();
      const px=+r.price||+r.avg_price||+r.px||0,vol=+r.vol||+r.volume||+r.qty||+r.quantity||0;
      const fee=+r.fee||+r.fees||0,t=Date.parse(r.time||r.timestamp||r.filled_ts||0)/1000;
      return {s:sym,side:s,px,vol,fee,t:t||0}}
    function dayStart(t){const d=new Date(t*1000);return Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())/1000}
    function colorFor(v){if(v>0){const g=Math.min(255,100+Math.log10(v+1)*80);return `rgba(40,${g},70,0.3)`;}
      if(v<0){const r=Math.min(255,100+Math.log10(-v+1)*80);return `rgba(${r},40,40,0.3)`;}
      return 'rgba(255,255,255,0.02)';}
    function fifoPnL(f){f=f.filter(x=>x.t&&x.vol&&x.px&&(x.side==='buy'||x.side==='sell')).sort((a,b)=>a.t-b.t);
      const lot=new Map(),daily={},fillsByDay={};
      for(const x of f){
        if(!lot.has(x.s))lot.set(x.s,[]);
        if(!fillsByDay[dayStart(x.t)])fillsByDay[dayStart(x.t)]=[];
        fillsByDay[dayStart(x.t)].push(x);
        if(x.side==='buy')lot.get(x.s).push({q:x.vol,px:x.px});
        else{
          let rem=x.vol,real=0;
          while(rem>1e-12&&lot.get(x.s).length){
            const l=lot.get(x.s)[0];const take=Math.min(l.q,rem);
            real+=(x.px-l.px)*take;l.q-=take;rem-=take;if(l.q<=1e-12)lot.get(x.s).shift();}
          const k=dayStart(x.t);daily[k]=daily[k]||{p:0,t:0,w:0};daily[k].p+=real-x.fee;daily[k].t++;if(real-x.fee>0)daily[k].w++;
        }}
      return {daily,fillsByDay}}
    async function buildCal(monthOffset=0){
      const now=new Date(),utc=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth()+monthOffset,1));
      const y=utc.getUTCFullYear(),m=utc.getUTCMonth();document.getElementById('cal_title').textContent=utc.toLocaleString(undefined,{month:'long',year:'numeric'});
      const {daily,fillsByDay}=fifoPnL((await fetchJSON('/fills')).fills||[]);
      const firstDow=new Date(Date.UTC(y,m,1)).getUTCDay(),daysIn=new Date(Date.UTC(y,m+1,0)).getUTCDate();
      const grid=document.getElementById('cal_grid');grid.innerHTML='';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const e=document.createElement('div');e.className='cal-dow';e.textContent=d;grid.appendChild(e);});
      for(let i=0;i<firstDow;i++){const c=document.createElement('div');c.className='cal-cell muted';grid.appendChild(c);}
      for(let d=1;d<=daysIn;d++){
        const k=Date.UTC(y,m,d)/1000,v=daily[k]?.p||0,t=daily[k]?.t||0,w=daily[k]?.w||0,wr=t?((w/t)*100).toFixed(1)+'%':'—';
        const c=document.createElement('div');c.className='cal-cell';c.style.background=colorFor(v);
        c.innerHTML=`<div class="cal-date">${d}</div><div class="cal-pnl">${v?fmtMoney(v):'$0'}</div><div class="cal-metric">${t} trades · ${wr}</div>`;
        c.onclick=()=>showDayDetail(k,fillsByDay[k]||[]);
        grid.appendChild(c);
      }
      document.getElementById('cal_detail').innerHTML='';
    }
    function fmtMoney(x){const s=x<0?'-':'';const v=Math.abs(x);return s+'$'+v.toLocaleString(undefined,{maximumFractionDigits:2});}
    function showDayDetail(day,fills){
      const cont=document.getElementById('cal_detail');
      if(!fills.length){cont.innerHTML='<em>No trades this day.</em>';return;}
      const tbl=['<table><thead><tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>Fee</th></tr></thead><tbody>'];
      fills.forEach(f=>tbl.push(`<tr><td>${f.s}</td><td>${f.side}</td><td>${f.vol}</td><td>${f.px}</td><td>${f.fee}</td></tr>`));
      tbl.push('</tbody></table>');
      cont.innerHTML=tbl.join('');
    }
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('year').textContent=new Date().getFullYear();
      let offset=0;buildCal(0);
      document.getElementById('prev_month').onclick=()=>{offset--;buildCal(offset)};
      document.getElementById('next_month').onclick=()=>{offset++;buildCal(offset)};
    });
  </script>
</body>
</html>
