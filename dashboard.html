<!doctype html>
<html lang="en">
<head>
  <!-- Crypto System Dashboard UI v1.3.0 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{SERVICE_NAME} — Dashboard</title>
  <style>
    :root{
      --bg:#0c0f14;
      --card-bg:#121720;
      --border:#223041;
      --text:#e8eef7;
      --muted:#9bb0c3;
      --pill-bg:rgba(255,255,255,0.04);
      --btn-bg:#111722;
      --accent:#4ea7ff;
      --ok:#2e7d32;
      --warn:#c62828;
      --warn-bg:#301a1a;
      --ok-bg:#15281a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap-page{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    header h1{font-size:20px;margin:0}
    header .meta{color:var(--muted);font-size:13px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .card{border:1px solid var(--border);border-radius:12px;background:var(--card-bg);padding:14px}
    .card-header{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:baseline;margin-bottom:8px}
    .card-header h2{font-size:16px;margin:0}
    .subtext{opacity:.85;color:var(--muted);font-size:13px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .dot::before{content:"•";opacity:.6}

    /* Layout: 3 cards on top row, console full-width below (desktop) */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns:1fr;
      grid-template-areas:
        "control"
        "prices"
        "pnl"
        "console";
    }
    @media(min-width:1000px){
      .grid{
        grid-template-columns:1fr 1fr 1fr;
        grid-template-areas:
          "control prices pnl"
          "console console console";
      }
    }
    #control-panel{grid-area:control}
    #live-prices{grid-area:prices}
    #pnl{grid-area:pnl}
    #console-card{grid-area:console}

    .row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);background:var(--btn-bg);color:var(--text);border-radius:8px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.success{border-color:var(--ok)}
    .btn.danger{border-color:var(--warn)}
    .link-open{font-size:12px;color:var(--muted);margin-left:6px}

    /* “Symbols / Strategies” small block that wraps inside the section */
    .mini-meta{margin-top:10px;padding:8px;border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-size:12px}
    .mini-meta code{white-space:pre-wrap;word-break:break-word}

    /* Live Prices table look matches prior UI */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      background:transparent;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    th, td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);background:rgba(255,255,255,0.03)}
    tbody tr:last-child td{border-bottom:none}
    .col-symbol{width:28%}
    .col-price{width:22%}
    .col-spark{width:30%}
    .col-updated{width:20%}
    canvas.spark{width:100%;height:28px;display:block}

    .stat-tiles{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    @media(min-width:600px){ .stat-tiles{grid-template-columns:repeat(4,1fr);} }
    .tile{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      background:rgba(255,255,255,0.02);
    }
    .tile .label{color:var(--muted);font-size:12px}
    .tile .val{font-size:18px;font-weight:700;margin-top:4px}
    .pos{background:var(--ok-bg)}
    .neg{background:var(--warn-bg)}

    pre.console{width:100%;min-height:260px;max-height:520px;overflow:auto;background:#0a0e16;border:1px solid var(--border);border-radius:10px;padding:12px;margin:0;white-space:pre-wrap}

    footer{margin-top:18px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap-page">
    <header>
      <h1>{SERVICE_NAME}</h1>
      <div class="meta">
        <span class="badge">App <strong>v{APP_VERSION}</strong></span>
        <span class="badge">Dashboard UI <strong>v1.3.0</strong></span>
        <span class="badge">Broker <strong id="badge_broker">{BROKER_BADGE}</strong></span>
      </div>
    </header>

    <div class="grid">
      <!-- ============ CONTROL PANEL (old Service, fully restored + start/stop) ============ -->
      <section id="control-panel" class="card">
        <div class="card-header">
          <h2>Control Panel</h2>
          <div class="subtext">
            <span>{SERVICE_NAME}</span>
            <span class="dot"></span>
            <span>v{APP_VERSION}</span>
            <span class="dot"></span>
            <span>{BROKER_TEXT}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Top group: old Service buttons -->
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/health')">GET /health</button>
            <a class="link-open" href="/health" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/diag/broker')">GET /diag/broker</button>
            <a class="link-open" href="/diag/broker" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/version')">GET /version</button>
            <a class="link-open" href="/version" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/config')">GET /config</button>
            <a class="link-open" href="/config" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button class="btn" onclick="fetchAndLog('/fills')">GET /fills</button>
            <a class="link-open" href="/fills" target="_blank" rel="noopener">open</a>
          </div>

          <!-- Scheduler controls (moved here) -->
          <div class="row" style="margin-top:6px">
            <button id="btn_sched_status" class="btn" onclick="schedulerStatus()">GET /scheduler/status</button>
            <a class="link-open" href="/scheduler/status" target="_blank" rel="noopener">open</a>
          </div>
          <div class="row">
            <button id="btn_sched_start" class="btn success" onclick="schedulerStart()">/scheduler/start</button>
            <button id="btn_sched_stop"  class="btn danger"  onclick="schedulerStop()">/scheduler/stop</button>
          </div>

          <!-- Symbols/Strategies in the section (wrap & stay inside) -->
          <div class="mini-meta" id="mini_meta">
            <div><strong>Symbols:</strong> <code id="meta_symbols">—</code></div>
            <div><strong>Strategies:</strong> <code id="meta_strategies">—</code></div>
          </div>
        </div>
      </section>

      <!-- ============ LIVE PRICES (original table layout) ============ -->
      <section id="live-prices" class="card">
        <div class="card-header">
          <h2>Live Prices</h2>
          <div class="subtext">From /price/* — <span id="prices_hint">30s auto-refresh</span></div>
        </div>

        <table>
          <thead>
            <tr>
              <th class="col-symbol">Symbol</th>
              <th class="col-price">Price</th>
              <th class="col-spark">Spark</th>
              <th class="col-updated">Updated</th>
            </tr>
          </thead>
          <tbody id="prices_tbody">
            <!-- rows inserted dynamically -->
          </tbody>
        </table>

        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="refreshPrices()">Refresh now</button>
        </div>
      </section>

      <!-- ============ P&L (as in your accepted version) ============ -->
      <section id="pnl" class="card">
        <div class="card-header">
          <h2>P&amp;L</h2>
          <div class="subtext">Aggregated from /pnl/summary</div>
        </div>

        <!-- Totals -->
        <div class="stat-tiles" id="pnl_tiles">
          <div class="tile"><div class="label">Realized</div><div class="val" id="pnl_realized">—</div></div>
          <div class="tile"><div class="label">Unrealized</div><div class="val" id="pnl_unreal">—</div></div>
          <div class="tile"><div class="label">Fees</div><div class="val" id="pnl_fees">—</div></div>
          <div class="tile"><div class="label">Equity</div><div class="val" id="pnl_equity">—</div></div>
        </div>

        <!-- Tables -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <h3 style="margin:6px 0">By Strategy (Top 5)</h3>
            <table id="tbl_strategy">
              <thead><tr><th>Strategy</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 style="margin:6px 0">By Symbol (Top 5)</h3>
            <table id="tbl_symbol">
              <thead><tr><th>Symbol</th><th>Realized</th><th>Unrealized</th><th>Fees</th><th>Equity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="refreshPnL()">Refresh P&amp;L</button>
        </div>
      </section>

      <!-- ============ CONSOLE (FULL-WIDTH SECOND ROW) ============ -->
      <section id="console-card" class="card">
        <div class="card-header">
          <h2>Console</h2>
          <div class="subtext">Action logs (Control Panel, Prices, P&amp;L)</div>
        </div>
        <pre id="console_log" class="console" spellcheck="false"></pre>
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="clearConsole()">Clear</button>
          <button class="btn" onclick="schedulerStatus()">Refresh Status</button>
          <button class="btn" onclick="refreshPrices()">Refresh Prices</button>
          <button class="btn" onclick="refreshPnL()">Refresh P&amp;L</button>
        </div>
      </section>
    </div>

    <footer>
      <div>© <span id="year"></span> {SERVICE_NAME}</div>
      <div>Broker: <strong>{BROKER_TEXT}</strong> · App v{APP_VERSION} · UI v1.3.0</div>
    </footer>
  </div>

  <script>
    /* ------------------------ Console helpers ------------------------ */
    function logToConsole(title, data) {
      try {
        const el = document.getElementById('console_log');
        if (!el) return;
        const time = new Date().toISOString();
        const payload = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
        el.textContent += `[${time}] ${title}:\n${payload}\n\n`;
        el.scrollTop = el.scrollHeight;
      } catch(e) { /* no-op */ }
    }
    function clearConsole() {
      const el = document.getElementById('console_log');
      if (el) el.textContent = '';
    }

    /* --------------------------- Fetch util -------------------------- */
    async function fetchAndLog(path){
      try{
        const r = await fetch(path);
        const j = await r.json();
        logToConsole(path, j);
        return j;
      }catch(e){
        logToConsole(path+':error', String(e));
        return null;
      }
    }

    /* ------------------------- Control Panel ------------------------- */
    async function schedulerStatus() {
      const j = await fetchAndLog('/scheduler/status');
      try{
        const running = !!(j && j.running);
        document.getElementById('btn_sched_start')?.toggleAttribute('disabled', running);
        document.getElementById('btn_sched_stop')?.toggleAttribute('disabled', !running);
      }catch(_){}
    }
    async function schedulerStart() {
      await fetchAndLog('/scheduler/start');
      schedulerStatus();
    }
    async function schedulerStop() {
      await fetchAndLog('/scheduler/stop');
      schedulerStatus();
    }

    async function initConfig() {
      const cfg = await fetchAndLog('/config');
      try{
        const syms = (cfg && (cfg.SYMBOLS || cfg.symbols)) || [];
        const strats = (cfg && (cfg.STRATEGIES || cfg.strategies)) || [];
        document.getElementById('meta_symbols').textContent = syms.join(', ');
        document.getElementById('meta_strategies').textContent = strats.join(', ');
        // cache for prices table
        window.__SYMBOLS__ = syms;
      }catch(_){}
    }

    /* -------------------------- Live Prices -------------------------- */
    function splitSymbol(sym) {
      const s = String(sym).toUpperCase().replace(/\s+/g,'');
      if (s.includes('/')) {
        const [base, quote] = s.split('/');
        return [base, quote];
      }
      if (s.endsWith('USD')) return [s.slice(0,-3), 'USD'];
      return [s, 'USD'];
    }
    async function fetchPriceSymbol(sym) {
      const [base, quote] = splitSymbol(sym);
      // Prefer /price/base/quote; fallback to /price/{symbol}
      try {
        const r = await fetch(`/price/${encodeURIComponent(base)}/${encodeURIComponent(quote)}`);
        if (r.ok) return await r.json();
      } catch(_) {}
      const r2 = await fetch(`/price/${encodeURIComponent(sym)}`);
      if (r2.ok) return await r2.json();
      throw new Error('No price route matched for ' + sym);
    }
    function fmt(n){
      if (n === null || n === undefined || isNaN(n)) return '—';
      if (Math.abs(n) >= 1000) return Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
      if (Math.abs(n) >= 1) return Number(n).toLocaleString(undefined,{maximumFractionDigits:4});
      return Number(n).toLocaleString(undefined,{maximumFractionDigits:8});
    }

    // simple sparkline using <canvas>
    function drawSpark(canvas, values){
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);
      if(!values || values.length < 2) return;

      const v = values.slice(-40); // last 40 points
      const min = Math.min(...v);
      const max = Math.max(...v);
      const spread = (max - min) || 1;
      const stepX = w / (v.length - 1);

      ctx.beginPath();
      ctx.moveTo(0, h - ((v[0]-min)/spread)*h);
      for(let i=1;i<v.length;i++){
        const x = i * stepX;
        const y = h - ((v[i]-min)/spread)*h;
        ctx.lineTo(x,y);
      }
      ctx.strokeStyle = '#82b1ff';
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    // price state
    const PRICE_STATE = { series:{} }; // symbol -> array of numbers

    function ensureRowForSymbol(tbody, sym){
      const id = 'row_' + btoa(sym);
      if (document.getElementById(id)) return;
      const tr = document.createElement('tr');
      tr.id = id;
      tr.innerHTML = `
        <td class="col-symbol">${sym}</td>
        <td class="col-price"><span id="px_${btoa(sym)}">…</span></td>
        <td class="col-spark"><canvas class="spark" id="sp_${btoa(sym)}"></canvas></td>
        <td class="col-updated"><span id="ts_${btoa(sym)}">—</span></td>
      `;
      tbody.appendChild(tr);
    }

    async function refreshPrices(){
      const syms = (window.__SYMBOLS__ || []);
      const tbody = document.getElementById('prices_tbody');
      if(!tbody) return;
      if(!syms.length){
        tbody.innerHTML = '<tr><td colspan="4" class="subtext">No symbols configured.</td></tr>';
        return;
      }
      // ensure rows exist in fixed order
      tbody.innerHTML = '';
      syms.forEach(s => ensureRowForSymbol(tbody, s));

      await Promise.all(syms.map(async (s) => {
        try{
          const j = await fetchPriceSymbol(s);
          const px = j && j.price != null ? Number(j.price) : null;
          const tnow = new Date().toISOString();

          // update price cell
          const pxEl = document.getElementById('px_' + btoa(s));
          if (pxEl) pxEl.textContent = fmt(px);

          // update spark series and draw
          if (!PRICE_STATE.series[s]) PRICE_STATE.series[s] = [];
          if (px != null && isFinite(px)) PRICE_STATE.series[s].push(px);
          const cv = document.getElementById('sp_' + btoa(s));
          drawSpark(cv, PRICE_STATE.series[s]);

          // updated time
          const tsEl = document.getElementById('ts_' + btoa(s));
          if (tsEl) tsEl.textContent = tnow;

          logToConsole('price', { symbol: s, price: px });
        }catch(e){
          logToConsole('price:error', { symbol: s, error: String(e) });
        }
      }));
    }

    let _priceTimer=null;
    function startPriceAutoRefresh(){
      stopPriceAutoRefresh();
      _priceTimer = setInterval(refreshPrices, 30000); // 30s to match prior UI
      const hint = document.getElementById('prices_hint');
      if (hint) hint.textContent = '30s auto-refresh';
    }
    function stopPriceAutoRefresh(){
      if (_priceTimer) clearInterval(_priceTimer);
      _priceTimer=null;
    }

    /* ------------------------------ P&L -------------------------------- */
    function setTile(id,val,highlight=false){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = fmt(val);
      const parent = el.closest('.tile');
      if (parent) {
        parent.classList.remove('pos','neg');
        if (highlight){
          parent.classList.add(val >= 0 ? 'pos' : 'neg');
        }
      }
    }
    function fillTable(tbody, rows, key) {
      tbody.innerHTML = '';
      rows.slice(0,5).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${String(r[key])}</td>
          <td>${fmt(r.realized)}</td>
          <td>${fmt(r.unrealized)}</td>
          <td>${fmt(r.fees)}</td>
          <td>${fmt(r.equity)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    async function refreshPnL() {
      const j = await fetchAndLog('/pnl/summary');
      if (!j || !j.ok) return;
      const t = j.total || { realized:0, unrealized:0, fees:0, equity:0 };
      setTile('pnl_realized', t.realized, true);
      setTile('pnl_unreal',  t.unrealized, true);
      setTile('pnl_fees',    t.fees);
      setTile('pnl_equity',  t.equity, true);
      const tbS = document.querySelector('#tbl_strategy tbody');
      const tbY = document.querySelector('#tbl_symbol tbody');
      fillTable(tbS, j.per_strategy || [], 'strategy');
      fillTable(tbY, j.per_symbol   || [], 'symbol');
    }

    /* ------------------------------ Init ------------------------------- */
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('year').textContent = new Date().getFullYear().toString();
      await initConfig();
      await schedulerStatus();
      await refreshPrices();
      startPriceAutoRefresh();
      await refreshPnL();
    });
  </script>
</body>
</html>
